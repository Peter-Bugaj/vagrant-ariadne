#!/usr/bin/env bash

RUBY_VERS="1.9.2"
RUBY_PATCH="p290"
RUBYGEM_VERS="1.8.15"
RVM_RUBY_NAME="rg_`echo $RUBYGEM_VERS | sed -e 's/\.//g'`"
PROJECT_GEMSET="ariadne"
BUNDLER_VERS="1.0.21"

# Work whether rubies or gemsets are already installed
rvm_gemset_create_on_use_flag=1
rvm --install use ruby-${RUBY_VERS}-${RUBY_PATCH}@${PROJECT_GEMSET} -n ${RVM_RUBY_NAME}

# Only install rubygems if not using this version
if [ ! `gem -v | grep $RUBYGEM_VERS` ] ; then
  rvm rubygems $RUBYGEM_VERS
fi

# Install bundler gem if not yet available
# (Our bundler version should be the latest version)
if ! echo $(gem list) | grep -F "bundler ($BUNDLER_VERS" > /dev/null; then
  gem install bundler -v $BUNDLER_VERS
fi

# Run bundler if any gems not installed
if ! bundle check > /dev/null; then
  bundle install
fi

# Loads a bash function so that "bundle exec" alias works
# inside and ourside project directory
# http://tomafro.net/2011/09/tip-automatic-bundle-exec-for-rake-and-more
be () {
  if [[ -a Gemfile ]]; then
    bundle exec $*
  else
    command $*
  fi
}

# Ensure vagrant and irb run with Gemfile bundle
alias vagrant="be vagrant"
alias irb="be irb"
alias knife="be knife"
alias librarian-chef="be librarian-chef"
